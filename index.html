<html>
  <head>
    <title>Nautilus</title>
    <script type="text/javascript">
      var isStopped = false;
      var lastReload = new Date();
      var lastAnim = new Date();
      var lastFrame = new Date();
      var lastLoaded = new Date();
      var lastScreenQuery = new Date();
      var lastScreen = new Date();

      function debugInfo() {
        var debug = document.getElementById("debug");
        debug.innerText = "Last reload: " + lastReload.toLocaleTimeString() +
          "\nLast frame: " + lastAnim.toLocaleTimeString() +
          "\nLast render: " + lastLoaded.toLocaleTimeString() +
          "\nLast screen: " + lastScreen.toLocaleTimeString();
      }

      function queue(f) {
        if (!isStopped) {
          setTimeout(f, 1000);
        }
      }

      function anim() {
	if (lastAnim.getTime() - lastLoaded.getTime() > 20000) {
          location.reload();
        }

        lastAnim = new Date();

        if (lastAnim.getTime() - lastFrame.getTime() > 10000) {
          frame();
        }

        if (lastAnim.getTime() - lastScreenQuery.getTime() > 10000) {
          screen();
        }

        debugInfo();

        queue(anim);
      }

      function frame() {
        lastFrame = lastAnim;
        document.getElementById("frame").src = 'https://s3-us-west-1.amazonaws.com/simplecast/nautilus.jpg?v=' + lastAnim.getTime();
      }

      function screen() {
        lastScreenQuery = lastAnim;
        var ph = new XMLHttpRequest();
        ph.open("HEAD", "https://s3-us-west-1.amazonaws.com/simplecast/previous.jpg");
        ph.onreadystatechange = function() {
          if (ph.readyState == 4) {
            var newScreen = new Date(ph.getResponseHeader("Last-Modified"));
            if (newScreen.getTime() > lastScreen.getTime()) {
              document.getElementById("prev").src = 'https://s3-us-west-1.amazonaws.com/simplecast/previous.jpg?v=' + lastAnim.getTime();
              lastScreen = newScreen;

              queue(screen);
            }
          }
        };
        ph.send();
      }

      function imgLoaded() {
        lastLoaded = new Date();
        debugInfo();
        queue(frame);
      }

      function toggle() {
        var bn = document.getElementById("toggle");
        if (isStopped) {
          bn.innerText = "Stop";
          isStopped = false;
          anim();
        } else {
          bn.innerText = "Resume";
          isStopped = true;
        }
      }
    </script>
  </head>
  <body style="text-align: center; background-color: #222; margin: 0">
    <div style="position: absolute; color: white; text-align: left; font-family: monospace">
      Version: 0.4
      <div id="debug">
      </div>
      <div id="toggle" style="background-color: #555; margin: 4px; padding: 12px; text-align: center; cursor: pointer" onclick="toggle()">
        Stop
      </div>
    </div>
    <img id="frame" height="100%"
         src="https://s3-us-west-1.amazonaws.com/simplecast/nautilus.jpg"
         onload="imgLoaded()">
    <img id="prev" height="100%"
         src="https://s3-us-west-1.amazonaws.com/simplecast/previous.jpg">
    <script type="text/javascript">
      anim();
    </script>
  </body>
</html>
